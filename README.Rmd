---
output:
  md_document:
    variant: markdown_github
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "README-figs/",
  cache.path = "README-cache/"
)
```

# Software

The getais package relies on GDAL, which can be installed here:
http://www.kyngchaos.com/software/frameworks
Note that the PROJ and GEOS frameworks need to be installed before GDAL.  

To make sure GDAL is working properly on a Mac, open Terminal and follow these instructions:
http://tilemill-project.github.io/tilemill/docs/guides/gdal/

# Setting environment

RStudio doesn't automatically find the GDAL directory, so you may have to modify the PATH variable. You can get the PATH by opening terminal and type 
```{r eval=FALSE}
> Sys.getenv("PATH")
```

Then set the PATH in R Studio. The piece in quotes for example is my path returned from Sys.getenv().
```{r}
Sys.setenv("PATH"="/Library/Frameworks/GDAL.framework/Programs:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/sbin:/Library/TeX/texbin")
```

# getais

The getais R package is simply a data processing package, meant to download and process the very large AIS datasets from MarineCadastre.gov. 

You can install the development version of the package with:

```{r, eval=TRUE, results='hide', message=FALSE, warning=FALSE}
# install.packages("devtools")
if("getais" %in% rownames(installed.packages()) == FALSE) {
  devtools::install_github("eric-ward/getais")
}
library(getais)
```
    
## An example processing script

Create data frame for all combinations

```{r load}
if (!file.exists("filtered")) dir.create("filtered")

all_combos = expand.grid("zone"=1:19,"year"=2009:2014,"month"=1:12)
```

As an example, we'll only use data from December and UTM Zone 3.

```{r filter}
subset = all_combos[which(all_combos$zone==3 & all_combos$month==12),]

head(subset)
```

Process the data for these combinations of months / years / zones. The user can also specify the status codes to keep, which defaults to 

```{r}
status_codes_to_keep = c(0, 7, 8, 9, 10, 11, 12, 13, 14, 15)
```

More details here: https://help.marinetraffic.com/hc/en-us/articles/203990998-What-is-the-significance-of-the-AIS-Navigational-Status-Values-#'

The additional information that can be joined in relates to the vessel and voyage. The vessel attributes can be specified with *vessel_attr*. These default to

```{r}
vessel_attr = c("VesselType","Length")
```

but can be changed, and other fields may be included ("IMO", "CallSign", "Name", "Width", "DimensionComponents"). The voyage attributes *voyage_attr* default to just including destination,

```{r}
voyage_attr = c("Destination")
```

but also allows other variables ("VariableID", "Cargo", "Draught", "ETA", "StartTime", "EndTime").  

### Running the function 

The downsample_ais() function also takes the 'every_minutes' argument, which finds observations from each vessel that are closest to that time. For example, if we wanted observations nearest to every 30 minutes, we'd use

```{r process, cache=FALSE, results='hide'}
downsample_ais(df = subset, every_minutes = 30)
```

And now we have a few hundered or thousand records per tab-delimitted output files in the 'filtered' folder,

```{r}
dir("filtered")
```

Using the 30-minute sampling of zone 3 for example, each year has < 10000 records. 
